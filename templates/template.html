<!DOCTYPE html>
<html>
    <head>
        <title>Large-scale Enhancer Screen Database</title>

        <!--  custom CSS -->
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='design.css') }}">

        <!-- DataTables core CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

        <!-- Buttons extension CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

    </head>
  
    <body>
        <!-- Division for header and logo -->
       	<div>
            <div class="header">
                <h1 id="title">Drosophila Immune Enhancer Atlas</h1>
                <a href="https://wunderlichlab.mystrikingly.com/"><img src="{{ url_for('static', filename='images/wunderlich_lab_clear.png') }}" class="logo" alt="Logo"></a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">

            <div class="tab active" data-target="#introduction"><b>Introduction</b></div>
            <div class="tab"        data-target="#region-search"><b>Search by Region</b></div>
            <div class="tab"        data-target="#gene-search"><b>Search by Genes</b></div>
            <div class="tab"        data-target="#activity-search"><b>Search by Activity Info</b></div>
        </div>

        <!-- Introduction -->
        <div id="introduction" class="tab-content active">
            <h2>Drosophila Immune Enhancer Atlas</h2>

            <!-- Citation Box -->
            <div style="background-color: #f0f8ff; padding: 1.5rem; border-left: 4px solid #5f9ea0; margin-bottom: 2rem; border-radius: 4px;">
                <h3 style="margin-top: 0;">About This Resource</h3>
                <p><strong>Citation:</strong> Cohen, L.B., Hadzic, T., Sauer, C., Gibbs, J.R., & Wunderlich, Z. (2025).
                    <em>A genome-wide survey reveals a diverse array of enhancers coordinates the Drosophila innate immune response.</em>
                    bioRxiv.<a href="https://doi.org/10.1101/2025.09.24.678314" target="_blank">https://doi.org/10.1101/2025.09.24.678314</a></p>

                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: bold; color: #5f9ea0;">Show Abstract</summary>
                    <p style="margin-top: 1rem; text-align: justify;">
                        To defend against microbes, animals regulate a complex immune response. The <em>Drosophila</em> innate immune
                        system deploys a large transcriptional induction of signaling proteins, anti-microbial effectors, and other
                        critical immune factors. This transcriptional response is encoded in enhancers, cis-regulatory sequences that
                        modulate gene expression by binding transcription factors (TFs). While enhancers and transcription factor
                        binding sites (TFBS) have been identified for several immune responsive genes in <em>Drosophila</em>, most
                        enhancers that regulate immune-induced genes are unknown. By identifying enhancers, we can understand how
                        their composition controls expression and contributes to infection outcome. We employed STARR-seq
                        (Self Transcribing Active Regulatory-Region sequencing) in a hemocyte-like cell line to identify
                        immune-specific enhancers across the <em>D. melanogaster</em> genome and performed ATAC-seq in hemocytes
                        extracted from adult flies to assess the chromatin state of these enhancers before and after immune stimulus.
                        We identified thousands of enhancers responsive to IMD stimulation, one of the two primary immune signaling
                        pathways in <em>Drosophila</em>. As expected, immune enhancers are enriched for motifs of Relish, an NF-κB
                        factor, and Kay/Jra, a bZip heterodimer pair, involved in the Imd and JNK pathways respectively, compared
                        to enhancers active in unstimulated cells. However, when grouping enhancers by their target gene's expression
                        timing or functional role or by the enhancers' chromatin accessibility pre- or post-stimulus, different groups
                        of TFBS motifs are enriched, suggesting distinct regulatory logic for different parts of the immune response.
                        Identification and characterization of the diverse array of enhancers that regulate the innate immune response
                        expands our understanding of how animals fight infections.
                    </p>
                </details>
            </div>

            <!-- Description -->
            <p id="description">
                This platform is the Wunderlich Lab’s web resource for querying and visualizing enhancers
                identified through STARR-seq in <em>Drosophila melanogaster</em> S2* cells. The database enables researchers
                to explore enhancer activity across three experimental conditions: Control, 20E hormone treatment,
                and IMD immune treatment.
            </p>

            <!-- What This Website Does -->
            <h3>What This Website Does</h3>
            <p>
                The Drosophila Immune Enhancer Atlas integrates high-throughput STARR-seq data with gene expression and
                functional annotation information. There are two types of enhancer data contained within.
                The first enhancer dataset contains all the enhancers identified in each treatment condition and
                can be searched by genomic position or by associated genes. The second enhancer data is more processed,
                and sorts enhancers by whether they are detected in just one, two, or all three conditions, termed "activity classes".
                The database allows users to:
            </p>
            <ul>
                <li>Search for enhancers by genomic position to find all enhancers within a specific region and their assigned genes.</li>
                <li>Search by gene to discover all enhancers regulating a specific gene across conditions.</li>
                <li>Search by activity class to find enhancers based on genomic position, accessibility, immune function, or temporal expression patterns.</li>
                <li>Apply filters, including activity scores, conditions, time clusters, and immune process annotations.</li>
                <li>Export search results as CSV, TSV, or Excel files for further analysis.</li>
            </ul>

            <!-- How to Use This Database -->
            <h3>How to Use This Database</h3>

            <div class="info-boxes">
                <!-- Search by Region Box -->
                <div class="info-box" id="regionBox">
                    <h4>Search by Region</h4>
                    <p>
                        Use this option when you have a Genomic Region and want to Identify Enhancers and their Associated Genes.<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Open the "Search by Region" tab.</li>
                        <li>Enter the chromosome (2L, 2R, 3L, 3R, X, Y, or 4) and the region start and end positions.</li>
                        <li>Alternatively, enter an enhancer name (e.g., 2L:100000–120000).</li>
                        <li>Optionally filter by activity score, condition, time cluster, or immune process.</li>
                        <li>Click "Submit" to view all enhancers in this region.</li>
                        <li>Download results as CSV, TSV, or XLSX.</li>
                    </ol>
                    <div style="text-align: center; margin-top: 1rem;">
                        <img src="{{ url_for('static', filename='images/time_course_graph.png') }}"
                             alt="Mean expression of four main clusters of immune responsive genes across first 24 hrs post stimulus from Schlamp et al 2021"
                             style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; padding: 0.5rem;">
                        <p style="font-size: 0.85em; color: #666; margin-top: 0.5rem; font-style: italic;">
                            Mean expression of four main clusters of immune responsive genes across first 24 hrs post stimulus from Schlamp et al 2021.
                        </p>
                    </div>
                </div>

                <!-- Search by Genes Box -->
                <div class="info-box" id="geneBox">
                    <h4>Search by Genes</h4>
                    <p>
                        Use this when you have a Gene of Interest and want to Find its Assigned Enhancers.<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Open the "Search by Genes" tab.</li>
                        <li>Enter a gene symbol or a FlyBase ID.</li>
                        <li>Set an activity score threshold (default: 0).</li>
                        <li>Optionally apply filters such as condition, time cluster, or immune process.</li>
                        <li>Click "Submit" to view all regulating enhancers.</li>
                        <li>Download results as CSV, TSV, or XLSX.</li>
                    </ol>
                </div>

                <!-- Activity Class Search Box -->
                <div class="info-box" id="activityBox">
                    <h4>Activity Class Search</h4>
                    <p>
                         Use this to Find Activity Class Enhancers with Specific Regulatory Properties.<br><br>
                        <strong>Steps:</strong>
                    </p>
                    <ol>
                        <li>Open the "Search by Activity Info" tab.</li>
                        <li>Select any of the following filters: activity class, accessibility, time cluster, or broad immune role.</li>
                        <li>Click "Submit" to view matching enhancers and their target genes.</li>
                        <li>Download results as CSV, TSV, or XLSX.</li>
                    </ol>
                    <div style="text-align: center; margin-top: 1rem;">
                        <img src="{{ url_for('static', filename='images/activity_class_venn.png') }}"
                             alt="Venn Diagram showing enhancer activity class distribution"
                             style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; padding: 0.5rem;">
                        <p style="font-size: 0.85em; color: #666; margin-top: 0.5rem; font-style: italic;">
                            Distribution of enhancers across different activity classes,
                            including overlaps between enhancers active under multiple experimental conditions.
                        </p>
                    </div>
                </div>
            </div>

            <!-- About the Data -->
            <h3>About the Data</h3>
            <p>The database contains STARR-seq data from S2* cells treated under three conditions:</p>
            <ul>
                <li><strong>Control:</strong> Baseline</li>
                <li><strong>20E:</strong> Hormone treatment</li>
                <li><strong>IMD:</strong> 20E and heat-killed <i>Serratia marcescens</i></li>
            </ul>

            <p>Each entry includes:</p>
            <ul>
                <li>Genomic coordinates of enhancer regions, along with a link the enhancers in the UCSC genome browser</li>
                <li>Genes found 15 kb upstream and 15 kb downstream of the enhancer</li>
                <li>Gene expression levels (transcripts per million (TPM) values) across conditions</li>
                <li>Enhancer activity scores from STARR-seq</li>
                <li>Accessibility information based on ATAC-seq from immune-induced hemocytes</li>
                <li>Gene annotations, including immune pathways and time clusters identified by Schlamp et al. 2021, as well as distance to enhancers</li>
            </ul>

            <p>Access the full dataset in the NCBI Gene Expression Omnibus under accession number
                <a target="_blank" href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE308695">GSE308695</a>
            </p>

            <!-- Questions or Issues -->
            <h3>Questions or Issues?</h3>
            <p>
                For questions about this database or the underlying data, please contact the Wunderlich Lab.<br>
                Dr. Zeba Wunderlich: <a href="mailto:zeba@bu.edu">zeba@bu.edu</a>
            </p>

            <!-- Acknowledgements -->
            <h3>Acknowledgements</h3>
            <p>
                This database was created with data provided by the Wunderlich Lab. We thank Dr. Zeba Wunderlich and Dr. Lianne Cohen
                for their support and guidance.
            </p>

            <p>
                This website was originally developed by Anushka Dongaonkar, Yuki Ito, Gary Twu, and Jahnavi Kodali as part of the course
                <strong>BF768 Biological Database Systems</strong> at Boston University, facilitated by Dr. Gary Benson.<br><br>
                Following the course, Anushka Dongaonkar continued to expand and maintain the project.
            </p>
        </div>

        <!-- Tab1 -->
        <div id="region-search" class="tab-content">
            <h4>Search by chromosomal region OR enhancer name</h4>
            <p style="font-size: 0.9em; color: #666;">Example coordinates: 2L, start: 10426653, end: 10427192 | Example enhancer: 2R:16125955-16138021</p>

            <form id="enhancer-form" action="{{ url_for('find_gene') }}" method="POST">
                <div style="display: grid; grid-template-columns: 150px 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <label>
                        Chromosome:<br>
                        <select name="chr" id="enhancer_chr">
                            <option value="">-- Select --</option>
                            <option value="2L">2L</option>
                            <option value="2R">2R</option>
                            <option value="3L">3L</option>
                            <option value="3R">3R</option>
                            <option value="4">4</option>
                            <option value="X">X</option>
                            <option value="Y">Y</option>
                        </select>
                    </label>

                    <label>
                        Start:<br>
                        <input type="number" id="enhancer_start" name="start" placeholder="e.g., 10426653">
                    </label>

                    <label>
                        End:<br>
                        <input type="number" id="enhancer_end" name="end" placeholder="e.g., 10427192">
                    </label>
                </div>

                <div style="margin: 1rem 0; text-align: center; font-weight: bold; color: #666;">
                    - OR -
                </div>

                <div style="margin-bottom: 1rem;">
                    <label>
                        Region Name:<br>
                        <input type="text" name="enhancer_name" id="enhancer_name"
                               placeholder="e.g., 2R:16125955-16138021"
                               style="width: 100%; max-width: 400px;">
                    </label>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                    <label>
                        Min Activity Score:
                        <input type="number" name="activity_score_min" value="0" min="0">
                    </label>

                    <label>
                        Condition:
                        <select name="condition" id="tab1_condition">
                            <option value="">-- All --</option>
                            {% for c in filter_options.conditions %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Time Cluster:
                        <select name="time_cluster" id="tab1_time_cluster">
                            <option value="">-- All --</option>
                            {% for tc in filter_options.time_clusters %}
                                <option value="{{ tc }}">{{ tc }}</option>
                            {% endfor %}
                        </select>
                    </label>

                    <label>
                        Immune Process:
                        <select name="immune_process" id="tab1_immune_process">
                            <option value="">-- All --</option>
                            {% for ip in filter_options.immune_processes %}
                                <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <button type="submit">Submit</button>
            </form>

            <div id="enhancer-results"></div>
        </div>


        <!-- Tab2 -->
        <div id="gene-search" class="tab-content">
            <h4>Enter a gene (symbol eg "Abd-B" or ID eg "FBgn0000119")</h4>

            <form id="gene-form" action="{{ url_for('find_enhancer') }}" method="POST">
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; margin-bottom: 1rem; align-items: end;">
                    <label>
                        Gene Symbol:<br>
                        <input type="text" name="symbol" id="gene_symbol" placeholder="Start typing gene name..." autocomplete="off">
                        <div id="gene-suggestions" class="autocomplete-suggestions"></div>
                    </label>

                    <span style="font-weight: bold; padding-bottom: 0.5rem; color: #666; align-self: center;">or</span>

                    <label>
                        Gene ID:<br>
                        <input type="text" name="geneid" id="gene_id" placeholder="e.g., FBgn0000119">
                    </label>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                    <label>
                        Activity Score Threshold:
                        <input type="number" name="activity_score" id="tab2_activity_score" value="0" min="0">
                    </label>
                    <label>
                        Condition:
                        <select name="condition" id="tab2_condition">
                            <option value="">-- All --</option>
                            {% for c in filter_options.conditions %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>
                        Time Cluster:
                        <select name="time_cluster" id="tab2_time_cluster">
                            <option value="">-- All --</option>
                            {% for tc in filter_options.time_clusters %}
                                <option value="{{ tc }}">{{ tc }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>
                        Immune Process:
                        <select name="immune_process" id="tab2_immune_process">
                            <option value="">-- All --</option>
                            {% for ip in filter_options.immune_processes %}
                                <option value="{{ ip }}">{{ ip }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <button type="submit">Submit</button>
            </form>

            <div id="gene-results"></div>
        </div>


        <!-- Tab3 -->
        <div id="activity-search" class="tab-content">
            <h4>Search enhancers by chromosomal region OR activity class/accessibility</h4>
            <p style="font-size: 0.9em; color: #666;">Example coordinates: 2L, start: 3452301, end: 3452810 | Example enhancer: 2L:3452301-3452810</p>

            <form id="activity-form" action="{{ url_for('activity_class_search') }}" method="POST">
                <!-- Region Search Section -->
                <div style="background: #f8fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ddd;">
                    <h5 style="margin-top: 0; color: #2c5aa0;">Search by Genomic Region</h5>
                    <div style="display: grid; grid-template-columns: 150px 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Chromosome:</span>
                            <select name="chr" id="tab3_chr">
                                <option value="">-- Select --</option>
                                <option value="2L">2L</option>
                                <option value="2R">2R</option>
                                <option value="3L">3L</option>
                                <option value="3R">3R</option>
                                <option value="4">4</option>
                                <option value="X">X</option>
                                <option value="Y">Y</option>
                            </select>
                        </label>

                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Start:</span>
                            <input type="number" id="tab3_start" name="start" placeholder="e.g., 10426653">
                        </label>

                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">End:</span>
                            <input type="number" id="tab3_end" name="end" placeholder="e.g., 10427192">
                        </label>
                    </div>

                    <div style="margin: 1rem 0; text-align: center; font-weight: bold; color: #666;">
                        - OR -
                    </div>

                    <div style="margin-bottom: 0;">
                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Region Name:</span>
                            <input type="text" name="enhancer_name" id="tab3_enhancer_name"
                                   placeholder="e.g., 2L:3452301-3452810"
                                   style="width: 100%; max-width: 400px;">
                        </label>
                    </div>
                </div>

                <!-- Activity Class/Accessibility Filters -->
                <div style="background: #f8fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ddd;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Activity Class:</span>
                            <select name="activity_class" id="tab3_activity_class">
                                <option value="">-- Select Activity Class --</option>
                                {% for ac in filter_options.activity_classes %}
                                    <option value="{{ ac }}">{{ ac }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label>
                            <span style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Accessibility:</span>
                            <select name="accessibility" id="tab3_accessibility">
                                <option value="">-- Select Accessibility --</option>
                                {% for access in filter_options.accessibilities %}
                                    <option value="{{ access }}">{{ access }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit">Search</button>
                    <button type="reset">Clear Filters</button>
                </div>
            </form>

            <div id="activity-results" style="margin-top: 2rem;"></div>
        </div>
















        <!-- JS Libraries -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script src="https://www.gstatic.com/charts/loader.js"></script>


        <script>
            $.fn.dataTable.ext.errMode = 'none';

            $(function(){
                // Tab switching
                $('.tab').click(function(){
                    $('.tab').removeClass('active');
                    $(this).addClass('active');
                    $('.tab-content').removeClass('active');
                    const target = $($(this).data('target'));
                    target.addClass('active');
                    $('html, body').animate({ scrollTop: 0 }, 600);
                });

                // Tab 1: Enhancer Search
                $('#enhancer-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#enhancer-results').html(html);

                        if ($.fn.DataTable.isDataTable('#geneTable')) {
                            $('#geneTable').DataTable().destroy();
                        }

                        setTimeout(() => {
                            if ($('#geneTable').length) {
                                $('#geneTable').DataTable({
                                    pageLength: 15,
                                    lengthMenu: [10, 15, 25, 50, 100],
                                    ordering: false,
                                    paging: true,
                                    searching: true,
                                    info: true,
                                    pagingType: 'full_numbers',
                                    scrollX: true,
                                    autoWidth: false
                                });
                            }
                            initializeCharts();
                            $('html, body').animate({ scrollTop: $('#enhancer-results').offset().top - 100 }, 600);
                        }, 200);
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Form submission failed:', error);
                        alert('Search failed. Please try again.');
                    });
                });

                // Tab 2: Gene Search
                $('#gene-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#gene-results').html(html);

                        if ($.fn.DataTable.isDataTable('#enhancerTable')) {
                            $('#enhancerTable').DataTable().destroy();
                        }

                        setTimeout(() => {
                            if ($('#enhancerTable').length) {
                                $('#enhancerTable').DataTable({
                                    pageLength: 15,
                                    lengthMenu: [10, 15, 25, 50, 100],
                                    order: [[3, 'desc']],
                                    pagingType: 'full_numbers',
                                    scrollX: true
                                });
                            }
                            initializeCharts();
                            $('html, body').animate({ scrollTop: $('#gene-results').offset().top - 100 }, 600);
                        }, 200);
                    })
                    .fail(() => alert('Search failed. Please try again.'));
                });

                // Tab 3: Activity Class Search
                $('#activity-form').submit(function(e){
                    e.preventDefault();
                    $.post(this.action, $(this).serialize())
                    .done(html => {
                        $('#activity-results').html(html);

                        if ($.fn.DataTable.isDataTable('#activityClassTable')) {
                            $('#activityClassTable').DataTable().destroy();
                        }

                        setTimeout(() => {
                            if ($('#activityClassTable').length) {
                                $('#activityClassTable').DataTable({
                                    pageLength: 15,
                                    lengthMenu: [10, 15, 25, 50, 100],
                                    order: [[0, 'asc']],
                                    pagingType: 'full_numbers',
                                    scrollX: true
                                });
                            }
                            initializeCharts();
                            $('html, body').animate({ scrollTop: $('#activity-results').offset().top - 100 }, 600);
                        }, 200);
                    })
                    .fail(() => alert('Search failed. Please try again.'));
                });

                // Gene Symbol Autocomplete
                (function() {
                    let debounceTimer;
                    let selectedIndex = -1;
                    let suggestions = [];

                    const geneInput = document.getElementById('gene_symbol');
                    const geneIdInput = document.getElementById('gene_id');
                    const suggestionsDiv = document.getElementById('gene-suggestions');

                    if (!geneInput || !suggestionsDiv) return;

                    function searchGenes(query) {
                        clearTimeout(debounceTimer);

                        if (query.length < 2) {
                            suggestionsDiv.classList.remove('active');
                            suggestionsDiv.innerHTML = '';
                            geneInput.classList.remove('autocomplete-active');
                            return;
                        }

                        debounceTimer = setTimeout(() => {
                            suggestionsDiv.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
                            suggestionsDiv.classList.add('active');
                            geneInput.classList.add('autocomplete-active');

                            $.ajax({
                                url: '/autocomplete_gene',
                                method: 'GET',
                                data: { term: query },
                                success: function(data) {
                                    suggestions = data;
                                    displaySuggestions(data);
                                },
                                error: function() {
                                    suggestionsDiv.innerHTML = '<div class="autocomplete-no-results">Error loading suggestions</div>';
                                }
                            });
                        }, 300);
                    }

                    function displaySuggestions(data) {
                        if (data.length === 0) {
                            suggestionsDiv.innerHTML = '<div class="autocomplete-no-results">No genes found</div>';
                            return;
                        }

                        let html = '';
                        data.forEach((item, index) => {
                            html += `
                                <div class="autocomplete-suggestion" data-index="${index}" data-value="${item.value}" data-geneid="${item.geneid}">
                                    <span class="gene-symbol">${item.value}</span>
                                    <span class="gene-id">${item.geneid}</span>
                                </div>
                            `;
                        });

                        suggestionsDiv.innerHTML = html;

                        document.querySelectorAll('.autocomplete-suggestion').forEach(elem => {
                            elem.addEventListener('click', function() {
                                selectSuggestion(this.dataset.value, this.dataset.geneid);
                            });
                        });
                    }

                    function selectSuggestion(symbol, geneid) {
                        geneInput.value = symbol;
                        geneIdInput.value = geneid;
                        suggestionsDiv.classList.remove('active');
                        suggestionsDiv.innerHTML = '';
                        geneInput.classList.remove('autocomplete-active');
                        selectedIndex = -1;
                        geneInput.dataset.lastSelected = symbol;
                    }

                    geneInput.addEventListener('input', function() {
                        searchGenes(this.value);
                        if (geneIdInput.value && this.value !== this.dataset.lastSelected) {
                            geneIdInput.value = '';
                        }
                    });

                    geneInput.addEventListener('focus', function() {
                        if (this.value.length >= 2 && suggestions.length > 0) {
                            suggestionsDiv.classList.add('active');
                            geneInput.classList.add('autocomplete-active');
                        }
                    });

                    geneInput.addEventListener('keydown', function(e) {
                        const suggestionElems = document.querySelectorAll('.autocomplete-suggestion');

                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, suggestionElems.length - 1);
                            updateSelection(suggestionElems);
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, -1);
                            updateSelection(suggestionElems);
                        } else if (e.key === 'Enter') {
                            if (selectedIndex >= 0 && suggestionElems[selectedIndex]) {
                                e.preventDefault();
                                const selected = suggestionElems[selectedIndex];
                                selectSuggestion(selected.dataset.value, selected.dataset.geneid);
                            }
                        } else if (e.key === 'Escape') {
                            suggestionsDiv.classList.remove('active');
                            geneInput.classList.remove('autocomplete-active');
                            selectedIndex = -1;
                        }
                    });

                    function updateSelection(elements) {
                        elements.forEach((elem, index) => {
                            if (index === selectedIndex) {
                                elem.classList.add('selected');
                                elem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                            } else {
                                elem.classList.remove('selected');
                            }
                        });
                    }

                    document.addEventListener('click', function(e) {
                        if (!geneInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                            suggestionsDiv.classList.remove('active');
                            geneInput.classList.remove('autocomplete-active');
                            selectedIndex = -1;
                        }
                    });
                })();

                // Info box clicks
                $('#regionBox').click(function() {
                    $('.tab[data-target="#region-search"]').click();
                });

                $('#geneBox').click(function() {
                    $('.tab[data-target="#gene-search"]').click();
                });

                $('#activityBox').click(function() {
                    $('.tab[data-target="#activity-search"]').click();
                });
            });

            // Load Google Charts
            google.charts.load('current', {'packages':['corechart']});

            // Tab 1: Condition Pie Chart
            function drawConditionPieChart() {
                const chartDataEl = document.getElementById('chart-data');
                if (!chartDataEl) return;

                const chartData = JSON.parse(chartDataEl.textContent);
                if (!chartData || !chartData.conditions) return;

                const conditionCounts = {};
                chartData.conditions.forEach(conditionList => {
                    conditionList.forEach(cond => {
                        const condition = cond.exp_condition;
                        conditionCounts[condition] = (conditionCounts[condition] || 0) + 1;
                    });
                });

                const data = google.visualization.arrayToDataTable([
                    ['Condition', 'Count'],
                    ...Object.entries(conditionCounts)
                ]);

                const options = {
                    title: 'Enhancers by Experimental Condition',
                    pieHole: 0.4,
                    colors: ['#5f9ea0', '#4a7c7e', '#6fa8aa'],
                    backgroundColor: { fill: '#f8fafb' }
                };

                const chart = new google.visualization.PieChart(document.getElementById('condition_pie_chart'));
                chart.draw(data, options);
            }

            // Tab 2: Activity Score Histogram
            function drawActivityHistogram() {
                const histDataEl = document.getElementById('histogram-data');
                if (!histDataEl) return;

                const histData = JSON.parse(histDataEl.textContent);
                if (!histData || !histData.scores) return;

                const dataArray = [['Score', 'Frequency']];
                histData.scores.forEach(score => {
                    if (score) dataArray.push([parseFloat(score), 1]);
                });

                const data = google.visualization.arrayToDataTable(dataArray);

                const options = {
                    title: 'Distribution of Enhancer Activity Scores',
                    legend: { position: 'none' },
                    histogram: { bucketSize: 50 },
                    hAxis: { title: 'Activity Score' },
                    vAxis: { title: 'Frequency' },
                    colors: ['#5f9ea0'],
                    backgroundColor: { fill: '#f8fafb' }
                };

                const chart = new google.visualization.Histogram(document.getElementById('activity_histogram'));
                chart.draw(data, options);
            }

            // Tab 3: Flexible Chart
            function updateTab3Chart() {
                const tab3DataEl = document.getElementById('tab3-data');
                if (!tab3DataEl) return;

                const tableData = JSON.parse(tab3DataEl.textContent);
                const chartType = document.getElementById('chart_type').value;
                const xAxis = document.getElementById('x_axis').value;

                const counts = {};
                tableData.forEach(row => {
                    const key = row[xAxis] || 'Unknown';
                    counts[key] = (counts[key] || 0) + 1;
                });

                const data = google.visualization.arrayToDataTable([
                    [xAxis.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 'Count'],
                    ...Object.entries(counts)
                ]);

                let chart, options;
                if (chartType === 'bar') {
                    options = {
                        title: `Distribution by ${xAxis.replace(/_/g, ' ')}`,
                        legend: { position: 'none' },
                        hAxis: { title: xAxis.replace(/_/g, ' ') },
                        vAxis: { title: 'Count' },
                        colors: ['#5f9ea0'],
                        backgroundColor: { fill: '#f8fafb' }
                    };
                    chart = new google.visualization.ColumnChart(document.getElementById('tab3_chart'));
                } else {
                    options = {
                        title: `Distribution by ${xAxis.replace(/_/g, ' ')}`,
                        pieHole: 0.4,
                        backgroundColor: { fill: '#f8fafb' }
                    };
                    chart = new google.visualization.PieChart(document.getElementById('tab3_chart'));
                }

                chart.draw(data, options);
            }

            // Initialize charts after DataTables
            function initializeCharts() {
                setTimeout(() => {
                    if (document.getElementById('condition_pie_chart')) {
                        google.charts.setOnLoadCallback(drawConditionPieChart);
                    }
                    if (document.getElementById('activity_histogram')) {
                        google.charts.setOnLoadCallback(drawActivityHistogram);
                    }
                    if (document.getElementById('tab3_chart')) {
                        google.charts.setOnLoadCallback(updateTab3Chart);
                    }
                }, 500);
            }
        </script>
    </body>
</html>